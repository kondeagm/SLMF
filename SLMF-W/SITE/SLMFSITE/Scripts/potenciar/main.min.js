//     Underscore.js 1.6.0
//     http://underscorejs.org
//     (c) 2009-2014 Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
//     Underscore may be freely distributed under the MIT license.
(function(){var n=this,t=n._,r={},e=Array.prototype,u=Object.prototype,i=Function.prototype,a=e.push,o=e.slice,c=e.concat,l=u.toString,f=u.hasOwnProperty,s=e.forEach,p=e.map,h=e.reduce,v=e.reduceRight,g=e.filter,d=e.every,m=e.some,y=e.indexOf,b=e.lastIndexOf,x=Array.isArray,w=Object.keys,_=i.bind,j=function(n){return n instanceof j?n:this instanceof j?void(this._wrapped=n):new j(n)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=j),exports._=j):n._=j,j.VERSION="1.6.0";var A=j.each=j.forEach=function(n,t,e){if(null==n)return n;if(s&&n.forEach===s)n.forEach(t,e);else if(n.length===+n.length){for(var u=0,i=n.length;i>u;u++)if(t.call(e,n[u],u,n)===r)return}else for(var a=j.keys(n),u=0,i=a.length;i>u;u++)if(t.call(e,n[a[u]],a[u],n)===r)return;return n};j.map=j.collect=function(n,t,r){var e=[];return null==n?e:p&&n.map===p?n.map(t,r):(A(n,function(n,u,i){e.push(t.call(r,n,u,i))}),e)};var O="Reduce of empty array with no initial value";j.reduce=j.foldl=j.inject=function(n,t,r,e){var u=arguments.length>2;if(null==n&&(n=[]),h&&n.reduce===h)return e&&(t=j.bind(t,e)),u?n.reduce(t,r):n.reduce(t);if(A(n,function(n,i,a){u?r=t.call(e,r,n,i,a):(r=n,u=!0)}),!u)throw new TypeError(O);return r},j.reduceRight=j.foldr=function(n,t,r,e){var u=arguments.length>2;if(null==n&&(n=[]),v&&n.reduceRight===v)return e&&(t=j.bind(t,e)),u?n.reduceRight(t,r):n.reduceRight(t);var i=n.length;if(i!==+i){var a=j.keys(n);i=a.length}if(A(n,function(o,c,l){c=a?a[--i]:--i,u?r=t.call(e,r,n[c],c,l):(r=n[c],u=!0)}),!u)throw new TypeError(O);return r},j.find=j.detect=function(n,t,r){var e;return k(n,function(n,u,i){return t.call(r,n,u,i)?(e=n,!0):void 0}),e},j.filter=j.select=function(n,t,r){var e=[];return null==n?e:g&&n.filter===g?n.filter(t,r):(A(n,function(n,u,i){t.call(r,n,u,i)&&e.push(n)}),e)},j.reject=function(n,t,r){return j.filter(n,function(n,e,u){return!t.call(r,n,e,u)},r)},j.every=j.all=function(n,t,e){t||(t=j.identity);var u=!0;return null==n?u:d&&n.every===d?n.every(t,e):(A(n,function(n,i,a){return(u=u&&t.call(e,n,i,a))?void 0:r}),!!u)};var k=j.some=j.any=function(n,t,e){t||(t=j.identity);var u=!1;return null==n?u:m&&n.some===m?n.some(t,e):(A(n,function(n,i,a){return u||(u=t.call(e,n,i,a))?r:void 0}),!!u)};j.contains=j.include=function(n,t){return null==n?!1:y&&n.indexOf===y?n.indexOf(t)!=-1:k(n,function(n){return n===t})},j.invoke=function(n,t){var r=o.call(arguments,2),e=j.isFunction(t);return j.map(n,function(n){return(e?t:n[t]).apply(n,r)})},j.pluck=function(n,t){return j.map(n,j.property(t))},j.where=function(n,t){return j.filter(n,j.matches(t))},j.findWhere=function(n,t){return j.find(n,j.matches(t))},j.max=function(n,t,r){if(!t&&j.isArray(n)&&n[0]===+n[0]&&n.length<65535)return Math.max.apply(Math,n);var e=-1/0,u=-1/0;return A(n,function(n,i,a){var o=t?t.call(r,n,i,a):n;o>u&&(e=n,u=o)}),e},j.min=function(n,t,r){if(!t&&j.isArray(n)&&n[0]===+n[0]&&n.length<65535)return Math.min.apply(Math,n);var e=1/0,u=1/0;return A(n,function(n,i,a){var o=t?t.call(r,n,i,a):n;u>o&&(e=n,u=o)}),e},j.shuffle=function(n){var t,r=0,e=[];return A(n,function(n){t=j.random(r++),e[r-1]=e[t],e[t]=n}),e},j.sample=function(n,t,r){return null==t||r?(n.length!==+n.length&&(n=j.values(n)),n[j.random(n.length-1)]):j.shuffle(n).slice(0,Math.max(0,t))};var E=function(n){return null==n?j.identity:j.isFunction(n)?n:j.property(n)};j.sortBy=function(n,t,r){return t=E(t),j.pluck(j.map(n,function(n,e,u){return{value:n,index:e,criteria:t.call(r,n,e,u)}}).sort(function(n,t){var r=n.criteria,e=t.criteria;if(r!==e){if(r>e||r===void 0)return 1;if(e>r||e===void 0)return-1}return n.index-t.index}),"value")};var F=function(n){return function(t,r,e){var u={};return r=E(r),A(t,function(i,a){var o=r.call(e,i,a,t);n(u,o,i)}),u}};j.groupBy=F(function(n,t,r){j.has(n,t)?n[t].push(r):n[t]=[r]}),j.indexBy=F(function(n,t,r){n[t]=r}),j.countBy=F(function(n,t){j.has(n,t)?n[t]++:n[t]=1}),j.sortedIndex=function(n,t,r,e){r=E(r);for(var u=r.call(e,t),i=0,a=n.length;a>i;){var o=i+a>>>1;r.call(e,n[o])<u?i=o+1:a=o}return i},j.toArray=function(n){return n?j.isArray(n)?o.call(n):n.length===+n.length?j.map(n,j.identity):j.values(n):[]},j.size=function(n){return null==n?0:n.length===+n.length?n.length:j.keys(n).length},j.first=j.head=j.take=function(n,t,r){return null==n?void 0:null==t||r?n[0]:0>t?[]:o.call(n,0,t)},j.initial=function(n,t,r){return o.call(n,0,n.length-(null==t||r?1:t))},j.last=function(n,t,r){return null==n?void 0:null==t||r?n[n.length-1]:o.call(n,Math.max(n.length-t,0))},j.rest=j.tail=j.drop=function(n,t,r){return o.call(n,null==t||r?1:t)},j.compact=function(n){return j.filter(n,j.identity)};var M=function(n,t,r){return t&&j.every(n,j.isArray)?c.apply(r,n):(A(n,function(n){j.isArray(n)||j.isArguments(n)?t?a.apply(r,n):M(n,t,r):r.push(n)}),r)};j.flatten=function(n,t){return M(n,t,[])},j.without=function(n){return j.difference(n,o.call(arguments,1))},j.partition=function(n,t){var r=[],e=[];return A(n,function(n){(t(n)?r:e).push(n)}),[r,e]},j.uniq=j.unique=function(n,t,r,e){j.isFunction(t)&&(e=r,r=t,t=!1);var u=r?j.map(n,r,e):n,i=[],a=[];return A(u,function(r,e){(t?e&&a[a.length-1]===r:j.contains(a,r))||(a.push(r),i.push(n[e]))}),i},j.union=function(){return j.uniq(j.flatten(arguments,!0))},j.intersection=function(n){var t=o.call(arguments,1);return j.filter(j.uniq(n),function(n){return j.every(t,function(t){return j.contains(t,n)})})},j.difference=function(n){var t=c.apply(e,o.call(arguments,1));return j.filter(n,function(n){return!j.contains(t,n)})},j.zip=function(){for(var n=j.max(j.pluck(arguments,"length").concat(0)),t=new Array(n),r=0;n>r;r++)t[r]=j.pluck(arguments,""+r);return t},j.object=function(n,t){if(null==n)return{};for(var r={},e=0,u=n.length;u>e;e++)t?r[n[e]]=t[e]:r[n[e][0]]=n[e][1];return r},j.indexOf=function(n,t,r){if(null==n)return-1;var e=0,u=n.length;if(r){if("number"!=typeof r)return e=j.sortedIndex(n,t),n[e]===t?e:-1;e=0>r?Math.max(0,u+r):r}if(y&&n.indexOf===y)return n.indexOf(t,r);for(;u>e;e++)if(n[e]===t)return e;return-1},j.lastIndexOf=function(n,t,r){if(null==n)return-1;var e=null!=r;if(b&&n.lastIndexOf===b)return e?n.lastIndexOf(t,r):n.lastIndexOf(t);for(var u=e?r:n.length;u--;)if(n[u]===t)return u;return-1},j.range=function(n,t,r){arguments.length<=1&&(t=n||0,n=0),r=arguments[2]||1;for(var e=Math.max(Math.ceil((t-n)/r),0),u=0,i=new Array(e);e>u;)i[u++]=n,n+=r;return i};var R=function(){};j.bind=function(n,t){var r,e;if(_&&n.bind===_)return _.apply(n,o.call(arguments,1));if(!j.isFunction(n))throw new TypeError;return r=o.call(arguments,2),e=function(){if(!(this instanceof e))return n.apply(t,r.concat(o.call(arguments)));R.prototype=n.prototype;var u=new R;R.prototype=null;var i=n.apply(u,r.concat(o.call(arguments)));return Object(i)===i?i:u}},j.partial=function(n){var t=o.call(arguments,1);return function(){for(var r=0,e=t.slice(),u=0,i=e.length;i>u;u++)e[u]===j&&(e[u]=arguments[r++]);for(;r<arguments.length;)e.push(arguments[r++]);return n.apply(this,e)}},j.bindAll=function(n){var t=o.call(arguments,1);if(0===t.length)throw new Error("bindAll must be passed function names");return A(t,function(t){n[t]=j.bind(n[t],n)}),n},j.memoize=function(n,t){var r={};return t||(t=j.identity),function(){var e=t.apply(this,arguments);return j.has(r,e)?r[e]:r[e]=n.apply(this,arguments)}},j.delay=function(n,t){var r=o.call(arguments,2);return setTimeout(function(){return n.apply(null,r)},t)},j.defer=function(n){return j.delay.apply(j,[n,1].concat(o.call(arguments,1)))},j.throttle=function(n,t,r){var e,u,i,a=null,o=0;r||(r={});var c=function(){o=r.leading===!1?0:j.now(),a=null,i=n.apply(e,u),e=u=null};return function(){var l=j.now();o||r.leading!==!1||(o=l);var f=t-(l-o);return e=this,u=arguments,0>=f?(clearTimeout(a),a=null,o=l,i=n.apply(e,u),e=u=null):a||r.trailing===!1||(a=setTimeout(c,f)),i}},j.debounce=function(n,t,r){var e,u,i,a,o,c=function(){var l=j.now()-a;t>l?e=setTimeout(c,t-l):(e=null,r||(o=n.apply(i,u),i=u=null))};return function(){i=this,u=arguments,a=j.now();var l=r&&!e;return e||(e=setTimeout(c,t)),l&&(o=n.apply(i,u),i=u=null),o}},j.once=function(n){var t,r=!1;return function(){return r?t:(r=!0,t=n.apply(this,arguments),n=null,t)}},j.wrap=function(n,t){return j.partial(t,n)},j.compose=function(){var n=arguments;return function(){for(var t=arguments,r=n.length-1;r>=0;r--)t=[n[r].apply(this,t)];return t[0]}},j.after=function(n,t){return function(){return--n<1?t.apply(this,arguments):void 0}},j.keys=function(n){if(!j.isObject(n))return[];if(w)return w(n);var t=[];for(var r in n)j.has(n,r)&&t.push(r);return t},j.values=function(n){for(var t=j.keys(n),r=t.length,e=new Array(r),u=0;r>u;u++)e[u]=n[t[u]];return e},j.pairs=function(n){for(var t=j.keys(n),r=t.length,e=new Array(r),u=0;r>u;u++)e[u]=[t[u],n[t[u]]];return e},j.invert=function(n){for(var t={},r=j.keys(n),e=0,u=r.length;u>e;e++)t[n[r[e]]]=r[e];return t},j.functions=j.methods=function(n){var t=[];for(var r in n)j.isFunction(n[r])&&t.push(r);return t.sort()},j.extend=function(n){return A(o.call(arguments,1),function(t){if(t)for(var r in t)n[r]=t[r]}),n},j.pick=function(n){var t={},r=c.apply(e,o.call(arguments,1));return A(r,function(r){r in n&&(t[r]=n[r])}),t},j.omit=function(n){var t={},r=c.apply(e,o.call(arguments,1));for(var u in n)j.contains(r,u)||(t[u]=n[u]);return t},j.defaults=function(n){return A(o.call(arguments,1),function(t){if(t)for(var r in t)n[r]===void 0&&(n[r]=t[r])}),n},j.clone=function(n){return j.isObject(n)?j.isArray(n)?n.slice():j.extend({},n):n},j.tap=function(n,t){return t(n),n};var S=function(n,t,r,e){if(n===t)return 0!==n||1/n==1/t;if(null==n||null==t)return n===t;n instanceof j&&(n=n._wrapped),t instanceof j&&(t=t._wrapped);var u=l.call(n);if(u!=l.call(t))return!1;switch(u){case"[object String]":return n==String(t);case"[object Number]":return n!=+n?t!=+t:0==n?1/n==1/t:n==+t;case"[object Date]":case"[object Boolean]":return+n==+t;case"[object RegExp]":return n.source==t.source&&n.global==t.global&&n.multiline==t.multiline&&n.ignoreCase==t.ignoreCase}if("object"!=typeof n||"object"!=typeof t)return!1;for(var i=r.length;i--;)if(r[i]==n)return e[i]==t;var a=n.constructor,o=t.constructor;if(a!==o&&!(j.isFunction(a)&&a instanceof a&&j.isFunction(o)&&o instanceof o)&&"constructor"in n&&"constructor"in t)return!1;r.push(n),e.push(t);var c=0,f=!0;if("[object Array]"==u){if(c=n.length,f=c==t.length)for(;c--&&(f=S(n[c],t[c],r,e)););}else{for(var s in n)if(j.has(n,s)&&(c++,!(f=j.has(t,s)&&S(n[s],t[s],r,e))))break;if(f){for(s in t)if(j.has(t,s)&&!c--)break;f=!c}}return r.pop(),e.pop(),f};j.isEqual=function(n,t){return S(n,t,[],[])},j.isEmpty=function(n){if(null==n)return!0;if(j.isArray(n)||j.isString(n))return 0===n.length;for(var t in n)if(j.has(n,t))return!1;return!0},j.isElement=function(n){return!(!n||1!==n.nodeType)},j.isArray=x||function(n){return"[object Array]"==l.call(n)},j.isObject=function(n){return n===Object(n)},A(["Arguments","Function","String","Number","Date","RegExp"],function(n){j["is"+n]=function(t){return l.call(t)=="[object "+n+"]"}}),j.isArguments(arguments)||(j.isArguments=function(n){return!(!n||!j.has(n,"callee"))}),"function"!=typeof/./&&(j.isFunction=function(n){return"function"==typeof n}),j.isFinite=function(n){return isFinite(n)&&!isNaN(parseFloat(n))},j.isNaN=function(n){return j.isNumber(n)&&n!=+n},j.isBoolean=function(n){return n===!0||n===!1||"[object Boolean]"==l.call(n)},j.isNull=function(n){return null===n},j.isUndefined=function(n){return n===void 0},j.has=function(n,t){return f.call(n,t)},j.noConflict=function(){return n._=t,this},j.identity=function(n){return n},j.constant=function(n){return function(){return n}},j.property=function(n){return function(t){return t[n]}},j.matches=function(n){return function(t){if(t===n)return!0;for(var r in n)if(n[r]!==t[r])return!1;return!0}},j.times=function(n,t,r){for(var e=Array(Math.max(0,n)),u=0;n>u;u++)e[u]=t.call(r,u);return e},j.random=function(n,t){return null==t&&(t=n,n=0),n+Math.floor(Math.random()*(t-n+1))},j.now=Date.now||function(){return(new Date).getTime()};var T={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"}};T.unescape=j.invert(T.escape);var I={escape:new RegExp("["+j.keys(T.escape).join("")+"]","g"),unescape:new RegExp("("+j.keys(T.unescape).join("|")+")","g")};j.each(["escape","unescape"],function(n){j[n]=function(t){return null==t?"":(""+t).replace(I[n],function(t){return T[n][t]})}}),j.result=function(n,t){if(null==n)return void 0;var r=n[t];return j.isFunction(r)?r.call(n):r},j.mixin=function(n){A(j.functions(n),function(t){var r=j[t]=n[t];j.prototype[t]=function(){var n=[this._wrapped];return a.apply(n,arguments),z.call(this,r.apply(j,n))}})};var N=0;j.uniqueId=function(n){var t=++N+"";return n?n+t:t},j.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var q=/(.)^/,B={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},D=/\\|'|\r|\n|\t|\u2028|\u2029/g;j.template=function(n,t,r){var e;r=j.defaults({},r,j.templateSettings);var u=new RegExp([(r.escape||q).source,(r.interpolate||q).source,(r.evaluate||q).source].join("|")+"|$","g"),i=0,a="__p+='";n.replace(u,function(t,r,e,u,o){return a+=n.slice(i,o).replace(D,function(n){return"\\"+B[n]}),r&&(a+="'+\n((__t=("+r+"))==null?'':_.escape(__t))+\n'"),e&&(a+="'+\n((__t=("+e+"))==null?'':__t)+\n'"),u&&(a+="';\n"+u+"\n__p+='"),i=o+t.length,t}),a+="';\n",r.variable||(a="with(obj||{}){\n"+a+"}\n"),a="var __t,__p='',__j=Array.prototype.join,"+"print=function(){__p+=__j.call(arguments,'');};\n"+a+"return __p;\n";try{e=new Function(r.variable||"obj","_",a)}catch(o){throw o.source=a,o}if(t)return e(t,j);var c=function(n){return e.call(this,n,j)};return c.source="function("+(r.variable||"obj")+"){\n"+a+"}",c},j.chain=function(n){return j(n).chain()};var z=function(n){return this._chain?j(n).chain():n};j.mixin(j),A(["pop","push","reverse","shift","sort","splice","unshift"],function(n){var t=e[n];j.prototype[n]=function(){var r=this._wrapped;return t.apply(r,arguments),"shift"!=n&&"splice"!=n||0!==r.length||delete r[0],z.call(this,r)}}),A(["concat","join","slice"],function(n){var t=e[n];j.prototype[n]=function(){return z.call(this,t.apply(this._wrapped,arguments))}}),j.extend(j.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}}),"function"==typeof define&&define.amd&&define("underscore",[],function(){return j})}).call(this);

/*! calc-polyfill 09-02-2015 */
!function(win,doc){"use strict";function contentLoaded(a,b){var c=!1,d=!0,e=a.document,f=e.documentElement,g=e.addEventListener,h=g?"addEventListener":"attachEvent",i=g?"removeEventListener":"detachEvent",j=g?"":"on",k=function(d){("readystatechange"!=d.type||"complete"==e.readyState)&&(("load"==d.type?a:e)[i](j+d.type,k,!1),!c&&(c=!0)&&b.call(a,d.type||d))},l=function(){try{f.doScroll("left")}catch(a){return void setTimeout(l,50)}k("poll")};if("complete"==e.readyState)b.call(a,"lazy");else{if(!g&&f.doScroll){try{d=!a.frameElement}catch(m){}d&&l()}e[h](j+"DOMContentLoaded",k,!1),e[h](j+"readystatechange",k,!1),a[h](j+"load",k,!1)}}if(!doc.querySelectorAll)return!1;var EMPTY="",CALC_RULE="^(\\s*?[\\s\\S]*):(\\s*?[\\s\\S]*?((\\-(webkit|moz)\\-)?calc\\(([\\s\\S]+)\\))[\\s\\S]*)?$",CSSRULES="((\\s*?@media[\\s\\S]*?){([\\s\\S]*?)}\\s*?})|(([\\s\\S]*?){([\\s\\S]*?)})",KEYFRAMES=new RegExp("((@.*?keyframes [\\s\\S]*?){([\\s\\S]*?}\\s*?)})","gi"),FONTFACE=new RegExp("((@font-face\\s*?){([\\s\\S]*?)})","gi"),COMMENTS=new RegExp("(\\/\\*[\\s\\S]*?\\*\\/)","gi"),IMPORTS=new RegExp("@import .*?;","gi"),CHARSET=new RegExp("@charset .*?;","gi"),PERCENT=/\d+%/,PT=/\d+pt/,PIXEL=/(\d+)px/g,REMEM=/\d+r?em/,REM=/\d+rem/,EM=/\d+em/,MATH_EXP=/[\+\-\/\*]?\d+(px|%|em|rem)?/g,PLACEHOLDER="$1",ONLYNUMBERS=/[\s\-0-9]/g,FONTSIZE="font-size",ADDMEDIA="@media",onTextResize=[],onWindowResize=[],utilities={camelize:function(a){return a.replace(/\-(\w)/g,function(a,b){return b.toUpperCase()})},trim:function(a){var b=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;return String.prototype.trim?a.trim():a.replace(b,"")},indexOf:function(a,b,c){var d=a.length>>>0;for(c=Number(c)||0,c=0>c?Math.ceil(c):Math.floor(c),0>c&&(c+=d);d>c;c++)if(c in a&&a[c]===b)return c;return-1},getStyle:function(a,b){return a.currentStyle?a.currentStyle[utilities.camelize(b)]:doc.defaultView&&doc.defaultView.getComputedStyle?doc.defaultView.getComputedStyle(a,null).getPropertyValue(b):a.style[utilities.camelize(b)]},getFontsize:function(a){var b,c=doc.createElement("span");return c.innerHTML="&nbsp;",c.style.position="absolute",c.style.lineHeight="1em",c.style.fontSize="1em",a.appendChild(c),b=c.offsetHeight,a.removeChild(c),b},addEvent:function(a,b,c){doc.addEventListener?a.addEventListener(b,c,!1):a.attachEvent("on"+b,c)},textResize:function(a){var b,c,d=function(){b=doc.createElement("span"),b.id="text-resize-control",b.innerHTML="&nbsp;",b.style.position="absolute",b.style.left="-9999px",b.style.lineHeight="1em",b.style.fontSize="1em",doc.body.insertBefore(b,doc.body.firstChild),c=b.offsetHeight},e=function(){var d=b.offsetHeight;return c===d?(win.requestAnimationFrame(e),!1):(c=d,a&&"function"==typeof a&&a(),void win.requestAnimationFrame(e))};d(),win.requestAnimationFrame(e)}},calcTest=function(){var a=document.createElement("div");return a.style.cssText="width: -moz-calc(10px); width: -webkit-calc(10px); width: calc(10px)",!!a.style.length},getStyleSheets=function(){for(var a,b=[],c=0,d=doc.styleSheets.length;d>c;c++)a=doc.styleSheets[c],a.href&&a.href!==EMPTY&&b.push(a.href);b.length>0&&loadStylesheets(b)},loadStylesheets=function(a){var b,c=0,d=a.length,e=[];if(win.XMLHttpRequest)b=new XMLHttpRequest;else try{b=new ActiveXObject("Microsoft.XMLHTTP")}catch(f){b=null}if(b)for(;d>c;c++)try{b.open("GET",a[c],!1),b.send(),200===b.status&&e.push(b.responseText)}catch(f){console.log("Error making request for file "+a[c]+": "+f.message)}e.length>0&&parseStylesheets(e)},parseStylesheets=function(a){for(var b=0,c=a.length;c>b;b++)a[b]=a[b].replace(COMMENTS,EMPTY).replace(CHARSET,EMPTY).replace(IMPORTS,EMPTY).replace(KEYFRAMES,EMPTY).replace(FONTFACE,EMPTY),dotheCalc(parseCSS(a[b]))},removeStyles=function(a){for(var b=0,c=a.length;c>b;b++)a[b].removeAttribute("style")},parseCSS=function(a,b){var c,d,e,f,g,h,i,j,k,l=[];for(b=b||"",e=new RegExp(CSSRULES,"gi");;){if(f=e.exec(a),null===f)break;if(g=utilities.trim((f[2]||f[5]).split("\r\n").join("\n")),-1!==g.indexOf(ADDMEDIA))h=f[3]+"\n}",l=l.concat(parseCSS(h,g.replace(ADDMEDIA,"")));else for(h=f[6].split("\r\n").join("\n").split(";"),c=0,d=h.length;d>c;c++){i=new RegExp(CALC_RULE,"gi").exec(h[c]);try{j=doc.querySelectorAll(g)}catch(m){console.log('Error trying to select "'+g+'": '+m.message);break}null!==i&&j.length&&(k={elements:j,media:b,values:utilities.trim(i[2]),formula:i[6],prop:utilities.trim(i[1]),placholder:utilities.trim(i[3])},k.formula.match(PERCENT)&&(k.onresize=!0),k.formula.match(REMEM)&&(k.ontextresize=!0),l.push(k))}}return l},dotheCalc=function(calcRules){for(var index=0,len=calcRules.length,obj,calc=function(obj){for(var i=0,len=obj.elements.length,refValue,modifier,matches,l,j,result,formula=obj.formula.replace(PIXEL,PLACEHOLDER);len>i;i++){for(matches=formula.match(MATH_EXP),l=matches.length,j=0;l>j;j++)matches[j].match(PERCENT)&&(refValue=obj.elements[i].parentNode.clientWidth,modifier=parseInt(matches[j],10)/100),matches[j].match(EM)&&(refValue=obj.elements[i].currentStyle?utilities.getFontsize(obj.elements[i]):parseInt(utilities.getStyle(obj.elements[i],FONTSIZE).replace(/px/,EMPTY),10),refValue.match&&refValue.match(PT)&&(refValue=Math.round(1.333333333*parseInt(refValue.replace(/pt/,""),10))),modifier=parseInt(matches[j],10)),matches[j].match(REM)&&(refValue=utilities.getStyle(doc.body,FONTSIZE).match(PERCENT)?16*parseInt(utilities.getStyle(doc.body,FONTSIZE).replace(/%/,EMPTY),10)/100:utilities.getStyle(doc.body,FONTSIZE).match(PT)?Math.round(1.333333333*parseInt(utilities.getStyle(doc.body,FONTSIZE).replace(/pt/,""),10)):parseInt(utilities.getStyle(doc.body,FONTSIZE).replace(/px/,EMPTY),10),modifier=parseInt(matches[j],10)),modifier&&(formula=formula.replace(matches[j],refValue*modifier));try{formula.match(ONLYNUMBERS)&&(result=eval(formula),obj.elements[i].style[utilities.trim(utilities.camelize(obj.prop))]=obj.values.replace(obj.placholder,result+"px"))}catch(e){}}};len>index;index++)obj=calcRules[index],obj.onresize&&-1===utilities.indexOf(onWindowResize,obj)&&onWindowResize.push(obj),obj.ontextresize&&-1===utilities.indexOf(onTextResize,obj)&&onTextResize.push(obj),obj.media!==EMPTY?win.matchMedia&&win.matchMedia(obj.media).matches?calc(obj):removeStyles(obj.elements):calc(obj)};contentLoaded(win,function(){calcTest()||(getStyleSheets(),onTextResize.length>0&&utilities.textResize(function(){dotheCalc(onTextResize)}),onWindowResize.length>0&&utilities.addEvent(win,"resize",function(){dotheCalc(onWindowResize)}))}),function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!win.requestAnimationFrame;++c)win.requestAnimationFrame=win[b[c]+"RequestAnimationFrame"],win.cancelAnimationFrame=win[b[c]+"CancelAnimationFrame"]||win[b[c]+"CancelRequestAnimationFrame"];win.requestAnimationFrame||(win.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=win.setTimeout(function(){b(c+d)},d);return a=c+d,e}),win.cancelAnimationFrame||(win.cancelAnimationFrame=function(a){clearTimeout(a)})}()}(window,document);
/*
 *  Copyright 2012-2013 (c) Pierre Duquesne <stackp@online.fr>
 *  Licensed under the New BSD License.
 *  https://github.com/stackp/promisejs
 */
(function(a){function b(){this._callbacks=[];}b.prototype.then=function(a,c){var d;if(this._isdone)d=a.apply(c,this.result);else{d=new b();this._callbacks.push(function(){var b=a.apply(c,arguments);if(b&&typeof b.then==='function')b.then(d.done,d);});}return d;};b.prototype.done=function(){this.result=arguments;this._isdone=true;for(var a=0;a<this._callbacks.length;a++)this._callbacks[a].apply(null,arguments);this._callbacks=[];};function c(a){var c=new b();var d=[];if(!a||!a.length){c.done(d);return c;}var e=0;var f=a.length;function g(a){return function(){e+=1;d[a]=Array.prototype.slice.call(arguments);if(e===f)c.done(d);};}for(var h=0;h<f;h++)a[h].then(g(h));return c;}function d(a,c){var e=new b();if(a.length===0)e.done.apply(e,c);else a[0].apply(null,c).then(function(){a.splice(0,1);d(a,arguments).then(function(){e.done.apply(e,arguments);});});return e;}function e(a){var b="";if(typeof a==="string")b=a;else{var c=encodeURIComponent;for(var d in a)if(a.hasOwnProperty(d))b+='&'+c(d)+'='+c(a[d]);}return b;}function f(){var a;if(window.XMLHttpRequest)a=new XMLHttpRequest();else if(window.ActiveXObject)try{a=new ActiveXObject("Msxml2.XMLHTTP");}catch(b){a=new ActiveXObject("Microsoft.XMLHTTP");}return a;}function g(a,c,d,g){var h=new b();var j,k;d=d||{};g=g||{};try{j=f();}catch(l){h.done(i.ENOXHR,"");return h;}k=e(d);if(a==='GET'&&k){c+='?'+k;k=null;}j.open(a,c);j.setRequestHeader('Content-type','application/x-www-form-urlencoded');for(var m in g)if(g.hasOwnProperty(m))j.setRequestHeader(m,g[m]);function n(){j.abort();h.done(i.ETIMEOUT,"",j);}var o=i.ajaxTimeout;if(o)var p=setTimeout(n,o);j.onreadystatechange=function(){if(o)clearTimeout(p);if(j.readyState===4){var a=(!j.status||(j.status<200||j.status>=300)&&j.status!==304);h.done(a,j.responseText,j);}};j.send(k);return h;}function h(a){return function(b,c,d){return g(a,b,c,d);};}var i={Promise:b,join:c,chain:d,ajax:g,get:h('GET'),post:h('POST'),put:h('PUT'),del:h('DELETE'),ENOXHR:1,ETIMEOUT:2,ajaxTimeout:0};if(typeof define==='function'&&define.amd)define(function(){return i;});else a.promise=i;})(this);


var Animation = (function(selectors) {
	var queuedHomeAnimation;
	var tl;
	var bgVisible = false;

	function init() {
		bind();
		hideSection('desarrollo', true);
		hideSection('energia', true);
		hideSection('reguladores', true);
		tl = new TimelineLite({
			// onComplete: function() {
			// 	_.isFunction(callback) && callback();
			// }
		});
	}

	//the wood background needs to be centered with the section image but when window
	//has bigger height we need to cover the space by making the navbar bigger!
	function getCollapsedBarHeight() {
		var backgroundTop = 410; //Change me if wood background css is touched
		var backgroundHeight = 348;
		var sectionHeight = window.innerHeight - 80;
		var offset = (sectionHeight - backgroundHeight - backgroundTop) / 2;
		//console.log('getCollapsedBarHeight: ',offset);
		return offset > 0 ? offset + 80 : 80;
	}

	function collapseNavigation(skipAnimation) {
		var sectionsHeight = window.innerHeight - 80;
		var bHeight = getCollapsedBarHeight();
		resizeBackground(bHeight);
		console.log('barHeight:', bHeight);
		
		if (skipAnimation) {
			TweenMax.set(selectors.navigation.container, {height: bHeight});
			TweenMax.set(selectors.navigation.top, {height: bHeight});
			TweenMax.set([selectors.sectionsContainer], {
				css: { height: 'calc(100% - 80px)' }
			});	
		} else {
			tl.add(tween({key: 'navigation-container-resize', target: selectors.navigation.container, height: bHeight}), '-=0.4');
			tl.add(tween({key: 'navigation-container-resize', target: selectors.navigation.top, height: bHeight}), '-=0.4');
			tl.add(tween({key: 'navigation-container-resize', target: selectors.sectionsContainer, height: sectionsHeight}), '-=0.4');
		}
	}

	function expandNavigation() {
		resizeBackground(297);
		tl.add(tween({key: 'navigation-container-resize', target: selectors.navigation.container, height: 297}), '-=0.4');
		tl.add(tween({key: 'navigation-container-resize', target: selectors.navigation.top, height: 80}), '-=0.4');
	}

	function resizeBackground(offset) {
		var height = window.innerHeight - offset;
		tl.add(tween({key: 'home-container-resize', target: selectors.home.container, heightOffset: offset }));
		tl.add(tween( {key: 'background-resize', target: selectors.background, height: height, offset: -(offset / 4)}), '-=0.4');
	}

	function fadeInBackground() {
		if (bgVisible == false) {
			bgVisible = true;
			tl.add( tween({key: 'background-fade-in', target: selectors.background}) );
		}		
	}

	function showHome() {
		var p = new promise.Promise();
		console.log('home show');
		tl.timeScale(1);
		setSectionTitleActive('none');
		fadeInBackground();
		TweenMax.set(
			[
				selectors.home.title,
				selectors.home.subtitle,
				selectors.home.legend
			],
			{ autoAlpha: 0 }
		);
		//hide section background
		TweenMax.set(selectors.sectionsContainer, {css: {'display': 'none'}});
		TweenMax.to(selectors.woodBackground, 0.2, {autoAlpha: 0});
		TweenMax.set(selectors.home.container, {autoAlpha: 1});
		tl.add(TweenMax.to(selectors.home.title, 0.1, {autoAlpha: 1}));
		tl.add(tween({key: 'page-header-in', target: selectors.home.title}));
		tl.add(TweenMax.to(selectors.home.subtitle, 0.01, {autoAlpha: 1}), '-=0.2');
		tl.add(tween({key: 'home-sub-in', target: selectors.home.subtitle}), '-=0.2');
		tl.add(TweenMax.to(selectors.home.legend, 0.01, {autoAlpha: 1}), '-=0.2');
		tl.add(tween({key: 'home-sub-in', target: selectors.home.legend}), '-=0.2');
		
		_.delay(function() {
			p.done();
		}, 400);
		return p;
	}

	function hideHome() {
		var p = new promise.Promise();
		console.log('Hiding Home');
		TweenMax.to(selectors.home.container, 0.1, {autoAlpha: 0});
		_.delay(function() {
			p.done();
		}, 500);
		return p;
	}

	function fadeInWoodBackground() {
		TweenMax.set(selectors.sectionsContainer, {css: {'display': 'block'}});
		TweenMax.set(selectors.sectionsContainer, {autoAlpha: 1});
		tl.add(tween({key: 'background-section-fade-in', target: selectors.woodBackground}), '+=0.25');
	}

	function fadeOutWoodBackground() {
		TweenMax.to(selectors.woodBackground, 0.2, {autoAlpha: 0});
		console.log('fadeOutBackground!');
	}

	function setSectionTitleActive(sectionName) {
		selectors.navigation.top.find('a').removeClass('active');
		selectors.navigation.top.find('.' + sectionName + '-caption a').addClass('active');
	}

	function showSection(sectionName, isTransitionBetweenSections) {
		var p = new promise.Promise();
		var section = selectors[sectionName];
		_.delay(function() {
			setSectionTitleActive(sectionName);
			TweenMax.set(section.header, {autoAlpha: 1});
			tl.add(tween({key: 'page-header-in', target: section.header}));
			if (isTransitionBetweenSections) {
				//tl.add(tween({key: 'page-element-fade-in', target: section.imageFood}), '-=0.55');
			} else {
				//tl.add(tween({key: 'food-item-in', target: section.imageFood}), '-=0.55');
			}
			tl.add(tween({key: 'page-element-fade-in', target: section.backLink}), '-=0.43');
			tl.add(tween({key: 'page-icon-in', target: section.icon}), '-=0.6');
			tl.add(tween({key: 'page-element-fade-in', target: section.keyword}), '-=0.6');
			tl.add(tween({key: 'page-element-fade-in', target: section.legend}), '-=0.4');
			tl.add(tween({key: 'page-menu-in', target: section.accordion, callback: function() {
				p.done();
			}}), '-=0.4');
			tl.timeScale(1.4);
			
		}, 1);
		return p;
	}

	function hideSection(sectionName, skipAnimation) {
		var p = new promise.Promise();
		var section = selectors[sectionName];
		//console.log('Hiding Section', sectionName);
		if (skipAnimation) {
			_.delay(function() {
				console.log('> hideSection:', sectionName);
				TweenMax.set(selectors.supplementImages, {autoAlpha: 0});
				_.each(section, function(JQuerySelector) {
					TweenMax.set(JQuerySelector, {autoAlpha: 0});
				});
				p.done();
			}, 100);
		} else {
			_.delay(function() {
				console.log('> animate hideSection', section);
				TweenMax.to(selectors.supplementImages, 0.2, {autoAlpha: 0});
				//tl.add(tween({key: 'food-item-out', target: section.imageFood}));
				_.each(section, function(JQuerySelector) {
					TweenMax.to(JQuerySelector, 0.2, {autoAlpha: 0});
				});
			}, 1);
			_.delay(function() {
				p.done();
			}, 500);
			//Animation to hide!
		}
		return p;
	}

	function bind() {
		//BACK BUTTONS
		$('.btn-back').hover(function(e){
			var arrow = $(this).find('.btn-arrow');
			tween( { key: 'button-arrow', mode: 'in', target: arrow } );
		}, function() {
			var arrow = $(this).find('.btn-arrow');
			tween( { key: 'button-arrow', mode: 'out', target: arrow } );	
		});
	}

	function tween( params ) {
		params = params || {};
		var key = params.key,
				target = params.target,
				home = selectors.home,
				callback = params.callback,
				isIn = params.mode == 'in';

		switch(key){
			case 'background-fade-in': {
				return TweenMax.to(target, 0.4, {
					autoAlpha: 1
				});
			}
			case 'home-sub-in': {
				return TweenMax.fromTo(target, 0.25, {
					x: - 200
				}, {
					x: 0
				});
			}
			case 'background-resize': {
				return TweenMax.to(target, 0.4, {
					'background-position-y': params.offset + 'px',
					ease: Cubic.easeOut
				});
			}
			case 'home-container-resize': {
				return TweenMax.to(target, 0.4, {
					height: window.innerHeight - params.heightOffset,
					ease: Cubic.easeOut,
					onComplete: callback
				});
			}
			case 'background-section-fade-in': {
				return TweenMax.fromTo(target, 0.45, {
					autoAlpha: 0,
					//y: 20
				}, {
					autoAlpha: 1,
					//y: 0,
					ease: Quart.easeOut
				});
			}
			case 'food-item-in': {
				return TweenMax.fromTo(target, 0.45, {
					autoAlpha: 0,
					y: 30
				}, {
					autoAlpha: 1,
					y: 0,
					ease: Quart.easeOut
				});
			}
			case 'food-item-out': {
				return TweenMax.fromTo(target, 0.2, {
					y: 0
				}, {
					autoAlpha: 0,
					y: 10,
					ease: Quart.easeIn
				});
			}
			case 'section-title-in': {
				//return TweenMax.to(target, )
			}
			case 'navigation-container-resize': {
				return TweenMax.to(target, 0.4, {
					height: params.height,
					ease: Quart.easeOut,
					onComplete: callback
				});
			}
			case 'page-header-in':
				return TweenMax.fromTo( target, 0.5, {
					x: - $(window).width() * 0.5
				},{
					x: 0,
					ease: Quart.easeOut
				});
			case 'page-header-out':
				return TweenMax.set( target, {autoAlpha: 0});
			
			case 'page-element-fade-in':
				return TweenMax.fromTo(target, 0.6, {
					autoAlpha: 0
				}, {
					autoAlpha: 1
				})
			case 'page-out':
				return TweenMax.fromTo(target, 0.3, {
					autoAlpha: 1
				}, {
					autoAlpha: 0
				});
			case 'page-icon-in':
				var tl = new TimelineLite();
				tl.to(target, 0.01, { autoAlpha: 1 } ),
				tl.fromTo(target, 0.5, {
					scale: 1.4,
				}, {
					scale: 1,
					ease: Quart.easeOut
				});
				return tl;
			case 'page-links-in':
				var tl = new TimelineLite();
				var easing = Quart.easeOut;
				tl.set( target, { autoAlpha: 0 });
				tl.fromTo(target.parent(), 0.2, {autoAlpha: 0},{ autoAlpha: 1, ease: easing });
				tl.fromTo(target.get(1), 0.4, {y: -10},{ autoAlpha: 1, y: 0, ease: easing });
				tl.fromTo(target.get(0), 0.4, {y: -10},{ autoAlpha: 1, y: 0, ease: easing }, '-=0.2');
				return tl;
			case 'page-menu-in':
				return TweenMax.fromTo(target, 0.65,
					{ y: 65, autoAlpha: 0 },
					{ 
						y: 0,
						autoAlpha: 1,
						ease: Quart.easeOut,
						onComplete: params.callback
					});
			case 'section-out':
				var tl = new TimelineLite();
				tl.fromTo(target, 0.2,{
					autoAlpha: 1
				}, {
					autoAlpha: 0,
					onComplete: function(){
						$(target).removeClass('active');
						TweenMax.to(target, 0.1, { autoAlpha: 1 } );
					}
				});
				tl.to(target, 0.7, { 
					height: 38,
					ease: Quart.easeOut,
					onComplete: function(){
						//TweenMax.set(target, 0.1, { height: '' });
					}
				}, '-=0.1');
				return tl;
			case 'section-in':
				var targetHeight = target.attr('data-content-height')
				var tl = new TimelineLite();
				//hide current title and once is hidden swap class
				tl.to(target, 0.1, { backgroundColor: 'transparent'});
				
				tl.to(target.find('a'), 0.1, {
					autoAlpha: 0.1,
					onComplete: function(){
						target.addClass('active');		
						TweenMax.to(target.find('a'), 0.3, {
							autoAlpha: 1
						});
					}
				}, '-=0.1');
				
				tl.to(target, 0.75, { 
					height: targetHeight,
					ease: Cubic.easeOut,
					onComplete: function(){
						TweenMax.set(target, { backgroundColor: ''});
						//TweenMax.to(target, 0.1, { className: '+=active'});
					}
				});

				//fade in
				tl.fromTo(target.find('.section-content'), 0.65, {
					autoAlpha: 0
				},{ 
					autoAlpha: 1,
				}, '-=0.6');
				return tl;
			case 'button-arrow':
				// console.log(target);

				return TweenMax.to(target, 0.1, {
					width: isIn ? 45 : 30,
					marginLeft: isIn ? -15: 0
				});

		}
	}

	return {
		init: init,
		showHome: showHome,
		hideHome: hideHome,
		showSection: showSection,
		hideSection: hideSection,
		expandNavigation: expandNavigation,
		collapseNavigation: collapseNavigation,
		fadeInWoodBackground: fadeInWoodBackground,
		fadeOutWoodBackground: fadeOutWoodBackground
	};
});

var Navigation = (function(selectors, animation) { 
	var currentSectionName;
	var isNavigationCollapsed = false;
	var onPageChangeCallback;
	var lastSectionName;
	var lockNavigation = false; // when transitioning between sections

	function init() {
		bind();
	}

	function closeCurrentSection(nextSectionName) {
		if (currentSectionName) {

			if (nextSectionName == 'home') {
				animation.fadeOutWoodBackground();
			}
			// closing home?
			if (currentSectionName == 'home') {
				animation.collapseNavigation();
			}
			return closeSection(currentSectionName);
		} else {
			console.error('No currect section to close');
		}
	}

	function closeSection(sectionName) {
		var p = new promise.Promise();
		if (sectionName) {
			lastSectionName = currentSectionName;
			if (sectionName == 'home') {
				animation.fadeInWoodBackground();
				animation.hideHome().then(function(){
					currentSectionName = undefined;
					p.done();
				})
			} else {
				animation.hideSection(sectionName)
				.then(function() {
					currentSectionName = undefined;
					p.done();
				});
			}
		}
		return p;
	}

	function openSection( sectionName ) {
		var p = new promise.Promise();
		if (sectionName !== currentSectionName) {
			currentSectionName = sectionName;
			onPageChangeCallback && onPageChangeCallback(sectionName);
			if (sectionName == 'home') {
				animation.showHome().then(function() {
					animation.expandNavigation();
					p.done();
				});
			} else {
				var isTransitionBetweenSections = lastSectionName != 'home';
				animation.showSection(sectionName, isTransitionBetweenSections).then(function() {
					p.done();
				});	
			}
			console.log('currentSection', currentSectionName, 'lastSectionName', lastSectionName);	
		} else {
			_.defer(function() {
				p.done();
			});
		}
		return p;
	}

	function onPageChange(callback) {
		onPageChangeCallback = callback;
	}

	function bind() {
		// Sections
		$('a[data-reveal-section]').click( function(e) {
			e.preventDefault();
			var sectionName = $(this).attr('data-reveal-section');
			if (currentSectionName != sectionName && lockNavigation == false) {
				lockNavigation = true;
				$('.sections').attr('data-active-section', sectionName);
				closeCurrentSection(sectionName)
				.then( function() {
					openSection(sectionName).then(function() {
						lockNavigation = false;
					});	
				});	
			}
		});

		window.onresize = function() {
			if (currentSectionName != 'home') {
				animation.collapseNavigation(true);//skip animation	
			}
		}
	}

	function revealSupplement(domElement, imgElement) {
		if (domElement && imgElement) {

			$(domElement).find('a').addClass('active');
			TweenMax.to(Selectors[currentSectionName].imageFood, 0.15, {autoAlpha: 0, onComplete: function() {
				Selectors.food.css('display', 'none');
			}});
			TweenMax.set(Selectors.supplementImages, {autoAlpha: 1});
			TweenMax.to($(imgElement), 0.15, {autoAlpha: 1, delay: .15});	
		} else {
			//click default supplement
			var firstAnchor = Selectors[currentSectionName].accordion.find('ul.supplements a').first();
			TweenMax.set(Selectors.supplementImages.find('.supplement'), {autoAlpha: 0});
			_.delay(function() {
				firstAnchor.removeClass('active');
				firstAnchor.trigger('click');
			}, 100);
			
		}
	}

	function hideSupplements() {
		TweenMax.set(Selectors.supplementImages.find('.supplement'), {autoAlpha: 0});
		Selectors.food.css('display', 'block');
		Selectors.accordions.find('.tab-suplementos a').removeClass('active');
	}

	return {
		init: init,
		closeCurrentSection: closeCurrentSection,
		revealSupplement: revealSupplement,
		hideSupplements: hideSupplements,
		onPageChange: onPageChange,
		openSection: openSection
	}

});

function createAccordion(sectionName, JQuerySelector, animation, onTabChangeCallback) {
	var proceso = JQuerySelector.find('.tab-proceso');
	var nutrientes = JQuerySelector.find('.tab-nutrientes');
	var suplementos = JQuerySelector.find('.tab-suplementos');

	function expandTab(tabSelector, skipAnimation) {
		var content = $(tabSelector).find('.tab-content');
		var link = $(tabSelector).find('tab-link');
		var contentHeight = content.data('content-height');
		var accordionHeight = 165 + contentHeight;
		if (skipAnimation) {
			//console.log('accordionHeight', accordionHeight);
			TweenMax.set(JQuerySelector, {height: accordionHeight});
			TweenMax.set(content, {autoAlpha: 1, height: contentHeight});
		} else {
			TweenMax.to(JQuerySelector, 0.4, {height: accordionHeight, ease: Quart.easeOut});
			TweenMax.to(content, 0.4, {autoAlpha: 1, height: contentHeight, ease: Quart.easeOut});
		}
	}

	function collapseTab(tabSelector, skipAnimation) {
		var content = $(tabSelector).find('.tab-content');
		var link = $(tabSelector).find('tab-link');
		if (skipAnimation) {
			TweenMax.set(content, {autoAlpha: 0, height: 0});
		} else {
			TweenMax.to( content, 0.14, {autoAlpha: 0});
			TweenMax.to(content, 0.3, {height: 0});
		}
	}

	function collapseActiveTab(skipAnimation) {
		var tab = getActiveTab();
		collapseTab(tab);
	}

	function expandActiveTab() {
		var tab = getActiveTab();
		expandTab(tab);
	}

	function getActiveTab() {
		return JQuerySelector.find('li.tab-active');
	}

	function getActiveTabName() {
		return getActiveTab().data('tab-name');
	}

	function setActiveTab(tabName) {
		JQuerySelector.find('li').removeClass('tab-active');
		JQuerySelector.find('li[data-tab-name="' + tabName + '"]').addClass('tab-active');
	}

	function bindTabClicks() {
		JQuerySelector.find('a.tab-link').click(function(event) {
			var targetTab = $(this).data('tab-expands');
			//different from current tab?
			if (getActiveTabName() != targetTab) {
				onTabChangeCallback && onTabChangeCallback(targetTab);
				collapseActiveTab();
				setActiveTab(targetTab);
				expandActiveTab();
			} else {
				console.log('already in that tab');
			}
			event.preventDefault();
		});
	}

	function reset() {
		collapseTab(proceso, true);
		collapseTab(nutrientes, true);
		collapseTab(suplementos, true);
		expandTab(proceso, true);
		setActiveTab('proceso');
	}

	function init() {
		reset();
		bindTabClicks();
	}

	init();
	
	return {
		reset: reset
	}
}

var Selectors = (function() {
	var home = $('.home');
	var nav = $('.navigation-bar');	
	var sections = $('.sections');
	var titles = $('.sections .titles');
	var sidebars = $('.sections .sidebars');
	var items = $('.sections .items');
	var products = $('.sections .products');
	var accordions = $('.sections .accordions');

	return {
			pageContainer: $('#potenciar'),
			background: $('#background'),
			woodBackground: $('.sections .wood-background'),
			sectionsContainer: sections,
			supplementImages: products,
			food: $('#potenciar .items .food'),
			accordions: accordions,
			home: {
				container: home,
				title: home.find('header h1'),
				subtitle: home.find('header h3'),
				legend: home.find('header h2')
			},
			navigation: {
				container: nav,
				top: nav.find('.top-bar'),
				bottom: nav.find('.bottom-bar')
			},
			reguladores: {
				header: titles.find('h1.reguladores'),
				backLink: titles.find('.btn-back'),
				imageFood: items.find('.food .reguladores'),
				keyword: sidebars.find('.reguladores h2.keyword'),
				icon: sidebars.find('.reguladores .sidebar-icon svg'),
				legend: sidebars.find('.reguladores p'),
				accordion: accordions.find('.reguladores')
			},
			desarrollo: {
				header: titles.find('h1.desarrollo'),
				backLink: titles.find('.btn-back'),
				imageFood: items.find('.food .desarrollo'),
				imageProduct: items.find('.products .desarrollo'),
				keyword: sidebars.find('.desarrollo h2.keyword'),
				icon: sidebars.find('.desarrollo .sidebar-icon svg'),
				legend: sidebars.find('.desarrollo p'),
				accordion: accordions.find('.desarrollo')
			},
			energia: {
				header: titles.find('h1.energia'),
				backLink: titles.find('.btn-back'),
				imageFood: items.find('.food .energia'),
				imageProduct: items.find('.products .energia'),
				keyword: sidebars.find('.energia .keyword'),
				icon: sidebars.find('.energia .sidebar-icon svg'),
				legend: sidebars.find('.energia p'),
				accordion: accordions.find('.energia')
			}
		};
})();

var Potenciar = {
	init: function(params) {
		var self = this;
		var animation = Animation(Selectors);
		var navigation = Navigation(Selectors, animation);

		function getActiveSectionName() {
			return $('.sections').attr('data-active-section');

		}

		function updateSectionImage(sectionName, tabName) {
			//console.log('updatingSectionName', sectionName, tabName);
			Selectors.food.css('display', 'block');
			var activeAccordion = $('.accordion.' + sectionName);
			console.log('activeAccordion', activeAccordion);
			$('.items .food .' + sectionName).each(function() {
				var isVisible = $(this).hasClass(tabName) ;
				console.log('tabs',this, 'tabName', tabName, isVisible);
				if (isVisible) {
					TweenMax.to(this, 0.15, {autoAlpha: 1, delay: 0.1});	
				} else {
					TweenMax.to(this, 0.15, {autoAlpha: 0});
					
				}
			});
		}

		function onSectionTabChange(tabName) {
			if (tabName != 'suplementos') {
				navigation.hideSupplements();
				Selectors.accordions.find('.supplements a').removeClass('active');
				updateSectionImage(getActiveSectionName(), tabName);
			} else {
				navigation.revealSupplement();
			}
		}

		var desarrolloAccordion = createAccordion('desarrollo', 
			Selectors.desarrollo.accordion, animation, onSectionTabChange);

		var energiaAccordion = createAccordion('energia',
			Selectors.energia.accordion, animation, onSectionTabChange);

		var reguladoresAccordion = createAccordion('reguladores',
			Selectors.reguladores.accordion, animation, onSectionTabChange);

		navigation.onPageChange(function(sectionName) {
			console.log('PageChange!');
			updateSectionImage(sectionName, 'proceso');
			desarrolloAccordion.reset();
			energiaAccordion.reset();
			reguladoresAccordion.reset();
		});

		function loadJSONSuplements() {
			var p = new promise.Promise();
			$.getJSON(rootAPI + 'productos/')
			.done(function(data){
				var imgContainer = Selectors.supplementImages;
				//clear previous menu items
				$("#potenciar").find('ul.supplements').empty();
				_.each(data, function(supplement, idx) {
					console.log('new supplement:', supplement);
					var selector = Selectors[supplement.group];
					var ulContainer = selector.accordion.find('ul.supplements');
					if (ulContainer && imgContainer) {
						var supplementId = "supplement-image-{0}".format(idx);
						//product container and image
						var aElement = $('<div class="supplement" id="{0}"><img src="{1}" /></div>'.format(supplementId, supplement.image_url));
						//buy button
						aElement.append('<a href="{0}" target="_blank" class="buyButton"></a>'.format(supplement.store_url));
						//li entry
						var listElement = $('<li data-image-id="{0}"><a href="#">{1}</a></li>'.format(supplementId, supplement.name.toUpperCase()));
						listElement.click(function(){
							var isActive = listElement.find('a').hasClass('active');
							if (! isActive) {
								navigation.hideSupplements();
								navigation.revealSupplement(listElement, aElement);	
							}
						});
						ulContainer.append(listElement);
						imgContainer.append(aElement);
					}
				});
		 		p.done();
		 	});
			return p;
		}

		_onLoadImages(params.images, function() {
			//load json url
			loadJSONSuplements()
			.then( function(){
				$("#potenciar").removeLoader({
					loader: $(".loader2"),
					onComplete: function(){
						animation.init();
						navigation.init();
						_.delay(function() {
							navigation.openSection('home');	
						});
					}
				});
			});
		});
	}
};

